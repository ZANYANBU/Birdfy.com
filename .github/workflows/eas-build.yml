# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Birdfy â€” EAS Build Pipeline
# Triggers on every push to `main` that touches the BirdfyMobile/ subdirectory.
# Builds a preview Android APK via Expo Application Services (EAS).
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: EAS Build â€” Android Preview

on:
  push:
    branches:
      - main
    # â”€â”€â”€ Path filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # The workflow only runs when at least one file inside BirdfyMobile/ has
    # changed. Pushing only web-layer edits (index.html, app.js, styles.css)
    # will NOT trigger a mobile build, saving your EAS build minutes.
    paths:
      - 'BirdfyMobile/**'

# Cancel any in-progress run for the same branch so you don't queue duplicates
# when pushing rapid commits.
concurrency:
  group: eas-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1 Â· Install Dependencies
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  install:
    name: ğŸ“¦ Install Dependencies
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the full repository at the commit that triggered the push.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Node.js 20 (LTS). The `cache` option automatically caches
      #    the npm dependency tree so subsequent runs are faster.
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # â”€â”€â”€ working-directory note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # `cache-dependency-path` points the caching layer at the correct
          # package-lock.json inside the BirdfyMobile/ subdirectory.
          # Without this, the action would look for a lock file at the repo
          # root and produce a cache miss every time.
          cache: 'npm'
          cache-dependency-path: BirdfyMobile/package-lock.json

      # 3. Install npm dependencies inside the mobile subdirectory.
      #    `working-directory` means every command in this step runs as if
      #    you had `cd BirdfyMobile` first â€” no path hacks needed.
      - name: Install npm dependencies
        working-directory: BirdfyMobile
        run: npm install --frozen-lockfile

      # 4. Cache the node_modules folder so the `build` job can restore it
      #    without repeating the full install.
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: BirdfyMobile/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('BirdfyMobile/package-lock.json') }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 Â· EAS Build
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ—ï¸ EAS Build (Android â€” preview)
    runs-on: ubuntu-latest
    needs: install   # wait for the install job to finish successfully

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: BirdfyMobile/package-lock.json

      # Restore the node_modules cache saved by the install job.
      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: BirdfyMobile/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('BirdfyMobile/package-lock.json') }}

      # Install EAS CLI globally. We pin a specific major version to avoid
      # unexpected breaking changes from auto-updates.
      - name: Install EAS CLI
        run: npm install -g eas-cli@latest

      # â”€â”€â”€ Authentication â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # EXPO_TOKEN is a repository secret you created in GitHub.
      # EAS CLI reads this environment variable automatically â€” no `eas login`
      # interactive prompt is needed in CI.
      - name: Authenticate with Expo
        run: echo "Expo token is loaded from secrets âœ“"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # â”€â”€â”€ EAS Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # --platform android      â†’ build an Android APK/AAB
      # --profile preview       â†’ uses the "preview" profile in eas.json
      #                           (produces a standalone APK, good for testing)
      # --non-interactive       â†’ required for CI; disables all prompts
      # working-directory       â†’ all EAS commands execute inside BirdfyMobile/
      #                           where eas.json and app.json live
      - name: Run EAS Build
        working-directory: BirdfyMobile
        run: eas build --platform android --profile preview --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
